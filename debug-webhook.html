<!DOCTYPE html>
<html>
<head>
    <title>Webhook Debugger</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #45a049;
        }
        .output {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            color: #4CAF50;
        }
        .error {
            color: #f44336;
        }
        .warning {
            color: #ff9800;
        }
        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>üîç Webhook Configuration Debugger</h1>
    
    <div class="section">
        <h2>1Ô∏è‚É£ Check Current Webhooks in localStorage</h2>
        <button onclick="checkWebhooks()">Check Webhooks</button>
        <button onclick="clearWebhooks()">Clear All Webhooks</button>
        <div id="webhook-output" class="output"></div>
    </div>

    <div class="section">
        <h2>2Ô∏è‚É£ Test Webhook Connection</h2>
        <label>Webhook URL:</label>
        <input type="text" id="test-url" value="https://silentminds.app.n8n.cloud/webhook-test/recurring" />
        <button onclick="testWebhook()">Test Connection</button>
        <div id="test-output" class="output"></div>
    </div>

    <div class="section">
        <h2>3Ô∏è‚É£ Set Correct Webhook</h2>
        <button onclick="setCorrectWebhook()">Set Recurring Webhook to silentminds.app.n8n.cloud</button>
        <div id="set-output" class="output"></div>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const output = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
            output.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
        }

        function clearOutput(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        function checkWebhooks() {
            clearOutput('webhook-output');
            const webhooks = localStorage.getItem('webhooks');
            
            if (!webhooks) {
                log('webhook-output', '‚ö†Ô∏è No webhooks found in localStorage', 'warning');
                return;
            }

            try {
                const parsed = JSON.parse(webhooks);
                log('webhook-output', `‚úÖ Found ${parsed.length} webhooks:`, 'success');
                parsed.forEach((w, i) => {
                    log('webhook-output', `\n${i + 1}. ${w.name}`, 'info');
                    log('webhook-output', `   Type: ${w.type}`, 'info');
                    log('webhook-output', `   URL: ${w.url}`, 'info');
                    log('webhook-output', `   Active: ${w.active}`, 'info');
                    log('webhook-output', `   ID: ${w.id}`, 'info');
                });
            } catch (e) {
                log('webhook-output', `‚ùå Error parsing webhooks: ${e.message}`, 'error');
            }
        }

        function clearWebhooks() {
            if (confirm('Are you sure you want to clear all webhooks? This will reset to defaults.')) {
                localStorage.removeItem('webhooks');
                log('webhook-output', '‚úÖ Webhooks cleared! Refresh the app to load defaults.', 'success');
            }
        }

        async function testWebhook() {
            clearOutput('test-output');
            const url = document.getElementById('test-url').value;
            
            log('test-output', `üîÑ Testing webhook: ${url}`, 'info');
            log('test-output', `üì§ Sending POST request with test data...`, 'info');

            const testData = {
                marketCategory: 'Test Category',
                subNiche: 'Test Niche',
                geography: 'Test Location',
                email: 'test@example.com',
                frequency: 'weekly',
                notes: 'Test from debugger',
                submittedAt: new Date().toISOString(),
                researchType: 'recurring',
                isInitialRun: true,
                isTest: true
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });

                log('test-output', `üì• Response Status: ${response.status} ${response.statusText}`, 
                    response.ok ? 'success' : 'error');
                
                const responseText = await response.text();
                log('test-output', `üìÑ Response Body (first 500 chars):\n${responseText.substring(0, 500)}`, 
                    response.ok ? 'success' : 'info');

                if (response.ok) {
                    log('test-output', '\n‚úÖ Webhook is working correctly!', 'success');
                } else {
                    log('test-output', '\n‚ùå Webhook returned an error. Check your n8n workflow.', 'error');
                }
            } catch (error) {
                log('test-output', `‚ùå Connection failed: ${error.message}`, 'error');
                log('test-output', '\nPossible issues:', 'warning');
                log('test-output', '  ‚Ä¢ CORS not enabled on n8n webhook', 'warning');
                log('test-output', '  ‚Ä¢ Webhook URL is incorrect', 'warning');
                log('test-output', '  ‚Ä¢ n8n workflow is not active', 'warning');
                log('test-output', '  ‚Ä¢ Network/firewall blocking the request', 'warning');
            }
        }

        function setCorrectWebhook() {
            clearOutput('set-output');
            
            const defaultWebhooks = [
                {
                    id: '1',
                    name: 'On-Demand Research Handler',
                    url: 'https://northsnow.app.n8n.cloud/webhook-test/query',
                    type: 'on-demand',
                    description: 'Handles immediate market research requests',
                    active: true,
                    createdAt: new Date().toISOString(),
                },
                {
                    id: '2',
                    name: 'Recurring Research Handler',
                    url: 'https://silentminds.app.n8n.cloud/webhook-test/recurring',
                    type: 'recurring',
                    description: 'Handles scheduled recurring research requests',
                    active: true,
                    createdAt: new Date().toISOString(),
                }
            ];

            localStorage.setItem('webhooks', JSON.stringify(defaultWebhooks));
            log('set-output', '‚úÖ Webhooks updated successfully!', 'success');
            log('set-output', '\nRecurring webhook set to:', 'info');
            log('set-output', 'https://silentminds.app.n8n.cloud/webhook-test/recurring', 'success');
            log('set-output', '\nüîÑ Please refresh your Market Intelligence app now.', 'warning');
        }

        // Auto-check on load
        window.onload = () => {
            checkWebhooks();
        };
    </script>
</body>
</html>

